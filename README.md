# Tympanometer

This Repository contains all of the software for the Tympanometer Duke BME Design Fellows Project. The code included at the current stage includes a server file, a server testing file, the necessary webhooks utilized by the Particle Photon, as well as all of the Particle Photon code. It will be updated periodically to include new code designed along the way. Below are descriptions of each file.


## `server.py`

This file includes all of the server functions. The current server functions included are described below.

1. A server function to send a certain amount of data to the MongoDB database. The data included is a subject ID, 7 datapoints of that subject's current pressure readings, and 7 datapoints of that subject's current microphone readings. This function is called several times by the Particle Photon throughout the process of acquiring data.

2. A server function to retrieve all the stored data within the database. Depending on how long the Photon is to record information, the amount of data received back from the database varies. It acquires the pressure readings as well as the corresponding microphone readings. Once all of this information is returned to the server, the server function creates a .csv file that contains two columns labeled "Mic_Values" and "Pressure_Values". 

3. A server function to connect to the Gmail email server and send an email containing the last .csv file generated by the server. It currently accesses my personal Gmail account and sends an email to itself, but this functionality can easily be changed to send emails to a number of different people from a more centralized Gmail account. The email tells the recipient which patient's information is currently being sent, and attaches the .csv file to the email.


## `tymp.c`

This file includes all of the code for the Particle Photon, including the setup, the loop, as well as all of the corresponding functions necessary to perform the tasks we need. It initializes pins for the pressure transducer, the microphone, and the speaker, as well as some digital pins for buttons if necessary down the road. The code flow is generally written below.

1. The pins along with the serial monitor are all initialized within the setup.

2. Everytime the loop runs, it tests to see if the Photon is connected to the internet. If it is connected, it will run through the program. If not, it will attempt to connect. 

3. Reads in data from the microphone and adds it to the 7-segment list for microphone values. 

4. Reads in data from the pressure transducer and adds it to the 7-segment list for pressure values.

5. If the two lists above are not filled, the loop will re-run, adding more values to each of the lists.

6. Once both lists have 7 datapoints, the loop will reach an if tree that tells the Particle Photon to publish an event and send these now 14 datapoints to the server.

7. For each run of the loop, an `overall_count` variable iterates up by one. Once this variable reaches a value of our choosing, The loop no longer sends datapoints to the server. It sees that enough datapoints have been sent, and delays for 10 seconds.

8. After the 10 second delay, the Particle Photon publishes another event. This event, though, is asking for the server to generate the .csv file with all of the data.

9. After the .csv file is generated, the Particle Photon pauses for 4 seconds, then publishes another event, telling the server to send an email of the .csv file for the current patient. 

10. This email indicates the end of the current process for the Particle Photon, so once the email has been sent, the Particle Photon is told to pause and wait for further instruction.

